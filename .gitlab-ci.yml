stages:
  - format
  - build
  - test

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  DOTNET_NOLOGO: "1"
  SIGN_FILE: "false"
  PROJECT_NAME: "Kentico.Xperience.ElasticSearch"

# Dotnet format stage
dotnet-format:
  stage: format
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "Running dotnet format..."
    - dotnet format --exclude ./examples/** --verify-no-changes
  only:
    changes:
      - "**/*.cs"
      - "**/*.csproj"
      - "**/*.props"
      - "**/*.targets"
      - "**/*.sln"
      - "**/Client/**/*.json"
      - "**/*.tsx"
      - "**/*.js"
      - ".gitlab-ci.yml"

# Build stage
build_admin_fe:
  stage: build
  interruptible: true
  image: node:21.7.3-alpine
  dependencies:
    - dotnet-format
  script:
    - cd src/${PROJECT_NAME}/Admin/Client
    - node --version
    - npm --version
    - npm ci --cache .npm --prefer-offline
    - npm run build
  only:
    changes:
      - "**/*.cs"
      - "**/*.csproj"
      - "**/*.props"
      - "**/*.targets"
      - "**/*.sln"
      - "**/Client/**/*.json"
      - "**/*.tsx"
      - "**/*.js"
      - ".gitlab-ci.yml"
  artifacts:
    paths:
      - src/${PROJECT_NAME}/Admin/Client/dist

build_be:
  stage: build
  interruptible: true
  image: mcr.microsoft.com/dotnet/sdk:8.0
  dependencies:
    - build_admin_fe
  script:
    - dotnet restore --locked-mode
    - dotnet build --configuration Release --no-restore
  only:
    changes:
      - "**/*.cs"
      - "**/*.csproj"
      - "**/*.props"
      - "**/*.targets"
      - "**/*.sln"
      - "**/Client/**/*.json"
      - "**/*.tsx"
      - "**/*.js"
      - ".gitlab-ci.yml"
  artifacts:
    paths:
      - app

# Test stage
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  dependencies:
    - build_admin_fe
    - build_be
  script:
    - dotnet test --configuration Release --no-build --no-restore
  only:
    changes:
      - "**/*.cs"
      - "**/*.csproj"
      - "**/*.props"
      - "**/*.targets"
      - "**/*.sln"
      - "**/Client/**/*.json"
      - "**/*.tsx"
      - "**/*.js"
      - ".gitlab-ci.yml"